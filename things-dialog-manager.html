<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../things-resource-selector/things-resource-dialog.html">
<link rel="import" href="../things-date-picker/things-date-picker-dialog.html">
<link rel="import" href="../things-image-selector/things-image-selector-dialog.html">
<link rel="import" href="../things-section/things-import-dialog.html">
<link rel="import" href="../things-detail/things-menu-detail-create-behavior.html">

<dom-module id="things-dialog-manager">
  <template>

    <things-resource-dialog id="common-dialog1"></things-resource-dialog>
    <things-resource-dialog id="common-dialog2"></things-resource-dialog>
    <things-resource-dialog id="common-dialog3"></things-resource-dialog>
    <things-resource-dialog id="common-dialog4"></things-resource-dialog>
    <things-resource-dialog id="common-dialog5"></things-resource-dialog>

    <things-date-picker-dialog id="date-picker-dialog"></things-date-picker-dialog>
    <things-image-selector-dialog id="image-selector-dialog"></things-image-selector-dialog>

    <things-import-dialog id="import-dialog"></things-import-dialog>

  </template>
  
  <script>
    Polymer({
      is: 'things-dialog-manager',

      properties: {

        openCallback: {
          type: Function
        }
      },

      behaviors: [ 
        Things.MenuDetailCreateBahavior
      ],

      /**
       * event 호출에 의한 dialog open 제어
       */
      attached: function() {
        document.addEventListener('things-open-popup-view', function(event) {
          var request = event.detail;
          this.openDialog(request.view, request.modal, request.openCallback);
        }.bind(this));

        document.addEventListener('things-open-menu-detail-view', function(event) {
          this.initOpener(event);
        }.bind(this));

        document.addEventListener('things-detail-view-created', function(event) {
          this.openDialog(event.detail, true, null);
        }.bind(this));

        document.addEventListener('things-date-picker-toggle', function(event) {
          this.openDateDialog(event.detail.dataObj, event.detail.callback);
        }.bind(this));

        document.addEventListener('things-image-selector-toggle', function(event) {
          this.openImageSelectorDialog(event.detail.dataObj, event.detail.callback);
        }.bind(this));

        document.addEventListener('things-import-dialog-toggle', function(event) {
          var request = event.detail;
          this.openImportDialog(request.config, request.model, request.columns, request.menuInfo);
        }.bind(this));
      },

      /**
       * Initialize Opener
       *
       * @param {Object} event
       */
      initOpener: function(event) {
        this.menuInfo = null;      
        this.menuInfo = event.detail.menuInfo; 
        this.resource = event.detail.resource; 
        this.resourceFormFields = event.detail.resourceFormFields;
      },

      /**
       * dialog open logic
       */
      openDialog: function(view, modal, openCallback) {
        var elements = this._nodes;

        var dialogs = elements.filter(function(element) {
          return (element.id.indexOf('common-dialog') >= 0 && element.active == false);
        })

        if(dialogs.length > 0) {
          var dialogSize = 'size' + dialogs.length;
          var element = dialogs[0];

          if(element) {
            var dialog = element.$.dialog
                      
            element.title = view.title;
            element.dialogSize = dialogSize;
            dialog.modal = modal;
            dialog.noCancelOnEscKey = false;
            var scrollable = element.$.scrollroot;

            if(element.detailView) {
              try {
                scrollable.removeChild(element.detailView);
              } catch(e) {
                console.log(e);
              }
            } 

            if(element.openCallback) {
              element.openCallback = null;
            }
            
            element.detailView = view;
            element.openCallback = openCallback;
            scrollable.appendChild(element.detailView);

            dialog.open();
          }
        }
      },

      /**
       * date pickier dialog open
       */
      openDateDialog: function(dataObj, callback) {
        this.$['date-picker-dialog'].dialogToggle(dataObj, callback);
      },

      /**
       * image selector dialog open
       */
      openImageSelectorDialog: function(dataObj, callback) {
        this.$['image-selector-dialog'].dialogToggle(dataObj, callback);
      },

      /**
       * import dialog open
       */
      openImportDialog: function(config, model, columns, menuInfo) {
        this.$['import-dialog'].open(config, model, columns, menuInfo);
      }
    })
  </script>
</dom-module>